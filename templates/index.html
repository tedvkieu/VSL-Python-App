<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>VSL Real-time Detection</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Arial', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                overflow-x: hidden;
            }

            .container {
                width: 100%;
                height: 100vh;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                display: flex;
                flex-direction: column;
            }

            .header {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                padding: 15px 20px;
                text-align: center;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            .header p {
                font-size: 0.9rem;
                opacity: 0.9;
            }

            .main-content {
                flex: 1;
                display: flex;
                padding: 10px;
                gap: 10px;
                height: calc(100vh - 80px);
            }

            /* Portrait mode - default */
            .video-section {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .results-section {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            /* Landscape mode */
            @media (orientation: landscape) and (max-width: 900px) {
                .main-content {
                    flex-direction: row;
                    height: calc(100vh - 70px);
                    padding: 5px;
                    gap: 5px;
                }

                .video-section {
                    flex: 0 0 70%;
                    max-width: 70%;
                }

                .results-section {
                    flex: 0 0 30%;
                    max-width: 30%;
                }

                .header {
                    padding: 10px 15px;
                }

                .header h1 {
                    font-size: 1.2rem;
                    margin-bottom: 3px;
                }

                .header p {
                    font-size: 0.8rem;
                }
            }

            .video-container {
                position: relative;
                width: 100%;
                aspect-ratio: 4 / 3;
                background: #000;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                flex: 1;
                max-width: 640px;
                margin: 0 auto;
            }

            #videoElement, #processedCanvas {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                aspect-ratio: 4 / 3;
                transform: scaleX(-1);
            }

            .overlay {
                position: absolute;
                top: 10px;
                left: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: bold;
                backdrop-filter: blur(5px);
                min-width: 80px;
                text-align: center;
            }

            .controls {
                display: flex;
                justify-content: center;
                gap: 8px;
                margin-top: 10px;
                flex-wrap: wrap;
            }

            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 20px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: bold;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .btn-secondary {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
            }

            .btn-success {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white;
            }

            .btn-danger {
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                color: white;
            }

            .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .results-panel {
                background: white;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                flex: 1;
                display: flex;
                flex-direction: column;
                max-height: 100%;
                overflow: hidden;
            }

            .results-panel h3 {
                color: #333;
                margin-bottom: 15px;
                font-size: 1.2rem;
                text-align: center;
            }

            .status-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #eee;
                font-size: 0.9rem;
            }

            .status-item:last-child {
                border-bottom: none;
            }

            .status-label {
                font-weight: bold;
                color: #555;
            }

            .status-value {
                color: #333;
                font-weight: normal;
            }

            .status-collecting {
                color: #28a745;
            }

            .status-idle {
                color: #6c757d;
            }

            .sequence-display {
                flex: 1;
                margin-top: 15px;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }

            .sequence-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .sequence-header h4 {
                color: #333;
                font-size: 1rem;
            }

            .sequence-counter {
                background: #e9ecef;
                color: #495057;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.8rem;
                font-weight: bold;
            }

            .sequence-content {
                flex: 1;
                background: #f8f9fa;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 10px;
                overflow-y: auto;
                min-height: 100px;
                word-wrap: break-word;
                line-height: 1.6;
                font-size: 0.9rem;
            }

            .sequence-content:empty::before {
                content: 'Chưa có nhãn nào...';
                color: #6c757d;
                font-style: italic;
            }

            .sequence-controls {
                display: flex;
                gap: 5px;
                margin-top: 10px;
            }

            .sequence-controls .btn {
                flex: 1;
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .error {
                background: #f8d7da;
                color: #721c24;
                padding: 10px;
                border-radius: 8px;
                margin: 10px 0;
                display: none;
                font-size: 0.85rem;
            }

            .loading {
                display: none;
                text-align: center;
                color: #666;
                font-style: italic;
                padding: 10px;
            }

            /* Mobile landscape specific adjustments */
            @media (orientation: landscape) and (max-height: 500px) {
                .header {
                    padding: 5px 10px;
                }

                .header h1 {
                    font-size: 1rem;
                }

                .header p {
                    font-size: 0.7rem;
                }

                .main-content {
                    height: calc(100vh - 50px);
                    padding: 3px;
                }

                .controls {
                    margin-top: 5px;
                }

                .btn {
                    padding: 6px 12px;
                    font-size: 0.75rem;
                }

                .results-panel {
                    padding: 10px;
                }

                .results-panel h3 {
                    font-size: 1rem;
                    margin-bottom: 10px;
                }

                .status-item {
                    padding: 6px 0;
                    font-size: 0.8rem;
                }

                .sequence-display {
                    margin-top: 10px;
                }

                .sequence-content {
                    min-height: 60px;
                    padding: 8px;
                    font-size: 0.8rem;
                }

                .overlay {
                    top: 5px;
                    left: 5px;
                    padding: 5px 8px;
                    font-size: 0.85rem;
                }
            }

            /* Animation */
            @keyframes pulse {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.02);
                }
                100% {
                    transform: scale(1);
                }
            }

            .collecting {
                animation: pulse 1s infinite;
            }

            .new-label {
                background: #d4edda;
                color: #155724;
                padding: 2px 6px;
                border-radius: 4px;
                margin: 1px;
                display: inline-block;
                animation: fadeIn 0.5s ease-in;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @media (max-width: 700px) {
                .video-container {
                    max-width: 100vw;
                    aspect-ratio: 4 / 3;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>🤟 TayTalk</h1>
                <p>Vietnamese Sign Language Recognition</p>
            </div>

            <div class="main-content">
                <div class="video-section">
                    <div class="video-container" id="videoContainer">
                        <video
                            id="videoElement"
                            autoplay
                            muted
                            playsinline></video>
                        <canvas id="processedCanvas"></canvas>
                        <div class="overlay" id="predictionOverlay">...</div>
                    </div>

                    <div class="controls">
                        <button class="btn btn-primary" id="startBtn">
                            📹 Start
                        </button>
                        <button class="btn btn-secondary" id="stopBtn" disabled>
                            ⏹️ Stop
                        </button>
                        <button class="btn btn-success" id="resetBtn">
                            🔄 Reset
                        </button>
                    </div>

                    <div class="error" id="errorMessage"></div>
                    <div class="loading" id="loadingMessage">
                        Đang khởi tạo camera...
                    </div>
                </div>

                <div class="results-section">
                    <div class="results-panel">
                        <h3>📊 Kết quả nhận dạng</h3>

                        <div class="status-item">
                            <span class="status-label">Trạng thái:</span>
                            <span
                                class="status-value status-idle"
                                id="collectingStatus"
                                >Chờ</span
                            >
                        </div>

                        <div class="status-item">
                            <span class="status-label">Model:</span>
                            <span class="status-value" id="modelStatus"
                                >Đang tải...</span
                            >
                        </div>

                        <div class="sequence-display">
                            <div class="sequence-header">
                                <h4>Chuỗi nhãn:</h4>
                                <div
                                    class="sequence-counter"
                                    id="sequenceCounter">
                                    0
                                </div>
                            </div>
                            <div
                                class="sequence-content"
                                id="sequenceContent"></div>
                            <div class="sequence-controls">
                                <button class="btn btn-danger" id="clearAllBtn">
                                    🗑️ Xóa tất cả
                                </button>
                                <button
                                    class="btn btn-secondary"
                                    id="removeLastBtn">
                                    ↶ Xóa cuối
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let stream = null;
            let isProcessing = false;
            let isRequesting = false;
            let canvas, ctx;
            let overlayCanvas, overlayCtx;
            let lastFrameTime = 0;
            const frameRate = 15;

            // Sequence management
            let labelSequence = [];
            let lastPrediction = '';

            const videoElement = document.getElementById('videoElement');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const resetBtn = document.getElementById('resetBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const removeLastBtn = document.getElementById('removeLastBtn');
            const errorMessage = document.getElementById('errorMessage');
            const loadingMessage = document.getElementById('loadingMessage');
            const predictionOverlay =
                document.getElementById('predictionOverlay');
            const sequenceContent = document.getElementById('sequenceContent');
            const sequenceCounter = document.getElementById('sequenceCounter');

            // Canvas setup
            canvas = document.createElement('canvas');
            ctx = canvas.getContext('2d');
            overlayCanvas = document.getElementById('processedCanvas');
            overlayCtx = overlayCanvas.getContext('2d', { willReadFrequently: false });

            // MediaPipe hand connections
            const HAND_CONNECTIONS = [
                [0, 1],
                [1, 2],
                [2, 3],
                [3, 4],
                [0, 5],
                [5, 6],
                [6, 7],
                [7, 8],
                [0, 9],
                [9, 10],
                [10, 11],
                [11, 12],
                [0, 13],
                [13, 14],
                [14, 15],
                [15, 16],
                [0, 17],
                [17, 18],
                [18, 19],
                [19, 20],
                [5, 9],
                [9, 13],
                [13, 17],
            ];

            const constraints = {
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user',
                },
            };

            async function startCamera() {
                try {
                    showLoading('Đang khởi tạo camera...');

                    stream = await navigator.mediaDevices.getUserMedia(
                        constraints
                    );
                    videoElement.srcObject = stream;

                    videoElement.onloadedmetadata = () => {
                        hideLoading();
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        setupCanvas();
                        startProcessing();
                    };
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    showError(
                        'Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập.'
                    );
                    hideLoading();
                }
            }

            function setupCanvas() {
                // Đảm bảo overlayCanvas luôn đúng tỉ lệ 4:3 và khớp video
                const vw = videoElement.videoWidth;
                const vh = videoElement.videoHeight;
                if (vw && vh) {
                    overlayCanvas.width = vw;
                    overlayCanvas.height = vh;
                    overlayCanvas.style.width = '100%';
                    overlayCanvas.style.height = '100%';
                }
            }

            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach((track) => track.stop());
                    stream = null;
                }
                videoElement.srcObject = null;
                isProcessing = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                clearCanvas();
            }

            function clearCanvas() {
                if (overlayCtx) {
                    overlayCtx.clearRect(
                        0,
                        0,
                        overlayCanvas.width,
                        overlayCanvas.height
                    );
                }
            }

            function startProcessing() {
                isProcessing = true;
                isRequesting = false;
                processFrame();
            }

            async function processFrame() {
                if (!isProcessing || !videoElement.videoWidth || isRequesting) {
                    setTimeout(processFrame, 1000 / frameRate);
                    return;
                }
                isRequesting = true;
                try {
                    // Resize frame nhỏ trước khi gửi (320x240)
                    const targetW = 320;
                    const targetH = 240;
                    canvas.width = targetW;
                    canvas.height = targetH;
                    ctx.drawImage(videoElement, 0, 0, targetW, targetH);
                    const frameData = canvas.toDataURL('image/jpeg', 0.7);

                    const response = await fetch('/process_frame', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ frame: frameData }),
                    });

                    const result = await response.json();

                    if (result.success) {
                        updateUI(result);
                        drawLandmarks(result.landmarks);
                        if (
                            result.prediction &&
                            result.prediction !== lastPrediction &&
                            result.prediction !== 'non-action'
                        ) {
                            addLabelToSequence(result.prediction);
                            lastPrediction = result.prediction;
                        }
                    } else {
                        console.error('Processing error:', result.error);
                    }
                } catch (error) {
                    console.error('Frame processing error:', error);
                }
                isRequesting = false;
                setTimeout(processFrame, 1000 / frameRate);
            }

            function drawLandmarks(landmarksData) {
                // Tối ưu: chỉ clear và vẽ khi có landmarks
                if (!overlayCtx) return;
                if (!landmarksData || landmarksData.length === 0) {
                    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    return;
                }
                overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                landmarksData.forEach((handData) => {
                    const landmarks = handData.landmarks;
                    const isLeftHand = handData.hand_type === 'Left';
                    const landmarkColor = isLeftHand ? '#00FF00' : '#FF0000';
                    const connectionColor = isLeftHand ? '#00CC00' : '#CC0000';
                    // Draw connections
                    overlayCtx.save();
                    overlayCtx.strokeStyle = connectionColor;
                    overlayCtx.lineWidth = 2;
                    overlayCtx.beginPath();
                    HAND_CONNECTIONS.forEach((connection) => {
                        const start = landmarks[connection[0]];
                        const end = landmarks[connection[1]];
                        if (start && end) {
                            const startX = (1 - start.x) * overlayCanvas.width;
                            const startY = start.y * overlayCanvas.height;
                            const endX = (1 - end.x) * overlayCanvas.width;
                            const endY = end.y * overlayCanvas.height;
                            overlayCtx.moveTo(startX, startY);
                            overlayCtx.lineTo(endX, endY);
                        }
                    });
                    overlayCtx.stroke();
                    overlayCtx.restore();
                    // Draw landmarks
                    overlayCtx.save();
                    overlayCtx.fillStyle = landmarkColor;
                    for (let i = 0; i < landmarks.length; i++) {
                        const landmark = landmarks[i];
                        const x = (1 - landmark.x) * overlayCanvas.width;
                        const y = landmark.y * overlayCanvas.height;
                        overlayCtx.beginPath();
                        overlayCtx.arc(x, y, 3, 0, 2 * Math.PI);
                        overlayCtx.fill();
                    }
                    overlayCtx.restore();
                });
            }

            function addLabelToSequence(label) {
                labelSequence.push(label);
                updateSequenceDisplay();
            }

            function updateSequenceDisplay() {
                sequenceCounter.textContent = labelSequence.length;

                if (labelSequence.length === 0) {
                    sequenceContent.innerHTML = '';
                    return;
                }

                const sequenceText = labelSequence.join(' → ');
                sequenceContent.innerHTML = sequenceText;

                // Scroll to bottom
                sequenceContent.scrollTop = sequenceContent.scrollHeight;
            }

            function clearAllLabels() {
                labelSequence = [];
                lastPrediction = '';
                updateSequenceDisplay();
            }

            function removeLastLabel() {
                if (labelSequence.length > 0) {
                    labelSequence.pop();
                    updateSequenceDisplay();
                }
            }

            function updateUI(result) {
                const prediction = result.prediction || '...';
                predictionOverlay.textContent = prediction;

                const collectingStatus =
                    document.getElementById('collectingStatus');
                if (result.collecting) {
                    collectingStatus.textContent = 'Đang thu thập';
                    collectingStatus.className =
                        'status-value status-collecting';
                    document
                        .getElementById('videoContainer')
                        .classList.add('collecting');
                } else {
                    collectingStatus.textContent = 'Chờ tín hiệu';
                    collectingStatus.className = 'status-value status-idle';
                    document
                        .getElementById('videoContainer')
                        .classList.remove('collecting');
                }
            }

            async function resetSequence() {
                try {
                    await fetch('/reset_sequence', { method: 'POST' });
                    predictionOverlay.textContent = '...';
                    clearCanvas();
                    lastPrediction = '';
                } catch (error) {
                    console.error('Reset error:', error);
                }
            }

            async function checkStatus() {
                try {
                    const response = await fetch('/get_status');
                    const status = await response.json();

                    const modelStatus = document.getElementById('modelStatus');
                    if (status.model_loaded) {
                        modelStatus.textContent = '✅ Sẵn sàng';
                        modelStatus.style.color = '#28a745';
                    } else {
                        modelStatus.textContent = '❌ Lỗi';
                        modelStatus.style.color = '#dc3545';
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }

            function hideError() {
                errorMessage.style.display = 'none';
            }

            function showLoading(message) {
                loadingMessage.textContent = message;
                loadingMessage.style.display = 'block';
            }

            function hideLoading() {
                loadingMessage.style.display = 'none';
            }

            // Event listeners
            startBtn.addEventListener('click', startCamera);
            stopBtn.addEventListener('click', stopCamera);
            resetBtn.addEventListener('click', resetSequence);
            clearAllBtn.addEventListener('click', clearAllLabels);
            removeLastBtn.addEventListener('click', removeLastLabel);

            // Handle window resize
            window.addEventListener('resize', () => {
                if (videoElement.videoWidth > 0) {
                    setupCanvas();
                }
            });

            // Check model status on page load
            checkStatus();

            // Handle page visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    isProcessing = false;
                } else if (stream && videoElement.srcObject) {
                    isProcessing = true;
                    processFrame();
                }
            });
        </script>
    </body>
</html>
